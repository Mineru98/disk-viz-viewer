<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disk Usage Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
        }

        .search-box input::placeholder {
            color: #888;
        }

        .search-box input:focus {
            outline: 2px solid #667eea;
        }

        .search-box select {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }

        .search-box select option {
            background: #1a1a2e;
            color: #fff;
        }

        .search-box button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .search-box button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .summary {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .summary h2 {
            font-size: 1.2rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .summary .total {
            font-size: 2rem;
            font-weight: bold;
        }

        .cache-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cache-badge {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .refresh-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .refresh-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .breadcrumb span {
            color: #667eea;
            cursor: pointer;
        }

        .breadcrumb span:hover {
            text-decoration: underline;
        }

        .results {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .result-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .info {
            flex: 1;
        }

        .name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .path {
            font-size: 0.85rem;
            color: #888;
        }

        .size-container {
            text-align: right;
            min-width: 120px;
        }

        .size {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .bar-container {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
            padding: 20px;
            border-radius: 12px;
            color: #ff5252;
            text-align: center;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        .children {
            padding-left: 30px;
            background: rgba(0, 0, 0, 0.2);
        }

        .children .result-item {
            padding: 10px 20px;
        }

        .toggle-children {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 0.85rem;
        }

        .toggle-children:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Disk Usage Viewer</h1>
            <p class="subtitle">Visualize your disk space usage</p>
        </header>

        <div class="search-box">
            <select id="driveSelect" style="display: none;"></select>
            <input type="text" id="pathInput" placeholder="Enter folder path" value="">
            <select id="depthSelect">
                <option value="1">Depth: 1</option>
                <option value="2">Depth: 2</option>
                <option value="3">Depth: 3</option>
            </select>
            <button id="analyzeBtn" onclick="analyze()">Analyze</button>
        </div>

        <div id="breadcrumb" class="breadcrumb" style="display: none;"></div>

        <div id="summary" class="summary" style="display: none;">
            <div class="cache-indicator" id="cacheIndicator" style="display: none;">
                <span class="cache-badge" id="cacheBadge">Ï∫êÏãúÎê®</span>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshCache()">Í∞±Ïã†</button>
            </div>
            <h2>Total Size</h2>
            <div class="total" id="totalSize"></div>
            <div class="path" id="rootPath"></div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const CACHE_PREFIX = 'disk_viz_cache_';
        let currentData = null;
        let osInfo = null;
        let isWindows = false;
        let isFromCache = false;

        // Ï∫êÏãú ÌÇ§ ÏÉùÏÑ±
        function getCacheKey(path, depth) {
            return CACHE_PREFIX + btoa(path + '|' + depth).replace(/[+/=]/g, '');
        }

        // Ï∫êÏãúÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        function getCachedData(path, depth) {
            try {
                const cacheKey = getCacheKey(path, depth);
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Ï∫êÏãú Îç∞Ïù¥ÌÑ∞Ïóê ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÍ∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
                    return data;
                }
            } catch (error) {
                console.error('Failed to get cached data:', error);
            }
            return null;
        }

        // Ï∫êÏãúÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function setCachedData(path, depth, data) {
            try {
                const cacheKey = getCacheKey(path, depth);
                const cacheData = {
                    ...data,
                    cachedAt: new Date().toISOString()
                };
                localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            } catch (error) {
                console.error('Failed to save cached data:', error);
                // Ï†ÄÏû•ÏÜåÍ∞Ä Í∞ÄÎìù Ï∞¨ Í≤ΩÏö∞ Ïò§ÎûòÎêú Ï∫êÏãú ÏÇ≠Ï†ú ÏãúÎèÑ
                if (error.name === 'QuotaExceededError') {
                    clearOldCache();
                    try {
                        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                    } catch (e) {
                        console.error('Failed to save after clearing old cache:', e);
                    }
                }
            }
        }

        // Ïò§ÎûòÎêú Ï∫êÏãú Ï†ïÎ¶¨ (ÏµúÍ∑º 50Í∞úÎßå Ïú†ÏßÄ)
        function clearOldCache() {
            try {
                const keys = Object.keys(localStorage).filter(key => key.startsWith(CACHE_PREFIX));
                if (keys.length > 50) {
                    // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨ÌïòÏó¨ Ïò§ÎûòÎêú Í≤É ÏÇ≠Ï†ú
                    const cacheEntries = keys.map(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            return { key, cachedAt: data.cachedAt || 0 };
                        } catch {
                            return { key, cachedAt: 0 };
                        }
                    }).sort((a, b) => new Date(a.cachedAt) - new Date(b.cachedAt));

                    // Ïò§ÎûòÎêú Ìï≠Î™© ÏÇ≠Ï†ú
                    const toDelete = cacheEntries.slice(0, cacheEntries.length - 50);
                    toDelete.forEach(entry => localStorage.removeItem(entry.key));
                }
            } catch (error) {
                console.error('Failed to clear old cache:', error);
            }
        }

        // Ï∫êÏãú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateCacheIndicator(show, isCached) {
            const cacheIndicator = document.getElementById('cacheIndicator');
            const cacheBadge = document.getElementById('cacheBadge');
            const refreshBtn = document.getElementById('refreshBtn');
            
            if (show) {
                cacheIndicator.style.display = 'flex';
                if (isCached) {
                    cacheBadge.textContent = 'Ï∫êÏãúÎê®';
                    cacheBadge.style.background = 'rgba(102, 126, 234, 0.2)';
                    cacheBadge.style.color = '#667eea';
                } else {
                    cacheBadge.textContent = 'ÏµúÏã†';
                    cacheBadge.style.background = 'rgba(76, 175, 80, 0.2)';
                    cacheBadge.style.color = '#4caf50';
                }
                refreshBtn.disabled = false;
            } else {
                cacheIndicator.style.display = 'none';
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú OS Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        async function loadOSInfo() {
            try {
                const response = await fetch('/api/os-info');
                osInfo = await response.json();
                isWindows = osInfo.isWindows;
                
                // Í∏∞Î≥∏ Í≤ΩÎ°ú ÏÑ§Ï†ï
                const pathInput = document.getElementById('pathInput');
                pathInput.value = osInfo.defaultPath;
                
                // Placeholder ÏÑ§Ï†ï
                if (isWindows) {
                    pathInput.placeholder = 'Enter folder path (e.g., C:\\Users, D:\\Projects)';
                } else {
                    pathInput.placeholder = 'Enter folder path (e.g., /home, /var)';
                }
                
                // WindowsÏù∏ Í≤ΩÏö∞ ÎìúÎùºÏù¥Î∏å ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ ÌëúÏãú
                if (isWindows && osInfo.drives && osInfo.drives.length > 0) {
                    const driveSelect = document.getElementById('driveSelect');
                    driveSelect.style.display = 'block';
                    driveSelect.innerHTML = '<option value="">Select Drive</option>';
                    osInfo.drives.forEach(drive => {
                        const option = document.createElement('option');
                        option.value = drive;
                        option.textContent = drive;
                        if (drive === osInfo.defaultPath) {
                            option.selected = true;
                        }
                        driveSelect.appendChild(option);
                    });
                    
                    // ÎìúÎùºÏù¥Î∏å ÏÑ†ÌÉù Ïãú Í≤ΩÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                    driveSelect.addEventListener('change', function() {
                        if (this.value) {
                            pathInput.value = this.value;
                            analyze();
                        }
                    });
                    
                    // Í≤ΩÎ°ú ÏûÖÎ†• Ïãú ÎìúÎùºÏù¥Î∏å ÏÑ†ÌÉù ÏóÖÎç∞Ïù¥Ìä∏
                    pathInput.addEventListener('input', function() {
                        const path = this.value.trim();
                        if (isWindows && path.length >= 2 && path[1] === ':') {
                            const drive = path.substring(0, 2) + '\\';
                            if (driveSelect.querySelector(`option[value="${drive}"]`)) {
                                driveSelect.value = drive;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load OS info:', error);
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú Linux ÏÑ§Ï†ï
                const pathInput = document.getElementById('pathInput');
                pathInput.value = '/';
                pathInput.placeholder = 'Enter folder path (e.g., /home, /var)';
            }
        }

        async function analyze(path, forceRefresh = false) {
            const pathInput = document.getElementById('pathInput');
            const depthSelect = document.getElementById('depthSelect');
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const analyzeBtn = document.getElementById('analyzeBtn');

            let targetPath = path || pathInput.value.trim();
            
            // Í∏∞Î≥∏ Í≤ΩÎ°ú ÏÑ§Ï†ï
            if (!targetPath) {
                if (isWindows && osInfo) {
                    targetPath = osInfo.defaultPath;
                } else {
                    targetPath = '/';
                }
            }
            
            pathInput.value = targetPath;
            const depth = depthSelect.value;

            // Ï∫êÏãú ÌôïÏù∏ (Í∞ïÏ†ú Í∞±Ïã†Ïù¥ ÏïÑÎãå Í≤ΩÏö∞)
            if (!forceRefresh) {
                const cachedData = getCachedData(targetPath, depth);
                if (cachedData && !cachedData.error) {
                    // Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                    isFromCache = true;
                    currentData = cachedData;
                    
                    // ÎìúÎùºÏù¥Î∏å ÏÑ†ÌÉù ÏóÖÎç∞Ïù¥Ìä∏ (WindowsÏù∏ Í≤ΩÏö∞)
                    if (isWindows) {
                        const driveSelect = document.getElementById('driveSelect');
                        const path = cachedData.rootPath;
                        if (path.length >= 2 && path[1] === ':') {
                            const drive = path.substring(0, 2) + '\\';
                            if (driveSelect && driveSelect.querySelector(`option[value="${drive}"]`)) {
                                driveSelect.value = drive;
                            }
                        }
                    }
                    
                renderBreadcrumb(cachedData.rootPath);
                renderSummary(cachedData);
                renderResults(cachedData);
                // Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                const summaryDiv = document.getElementById('summary');
                summaryDiv.style.display = 'block';
                updateCacheIndicator(true, true);
                    return;
                }
            }

            analyzeBtn.disabled = true;
            summaryDiv.style.display = 'none';
            updateCacheIndicator(false, false);
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing disk usage...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/analyze?path=${encodeURIComponent(targetPath)}&depth=${depth}`);
                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    updateCacheIndicator(false, false);
                    return;
                }

                // Ï∫êÏãúÏóê Ï†ÄÏû•
                setCachedData(targetPath, depth, data);
                isFromCache = false;
                currentData = data;
                
                // ÎìúÎùºÏù¥Î∏å ÏÑ†ÌÉù ÏóÖÎç∞Ïù¥Ìä∏ (WindowsÏù∏ Í≤ΩÏö∞)
                if (isWindows) {
                    const driveSelect = document.getElementById('driveSelect');
                    const path = data.rootPath;
                    if (path.length >= 2 && path[1] === ':') {
                        const drive = path.substring(0, 2) + '\\';
                        if (driveSelect && driveSelect.querySelector(`option[value="${drive}"]`)) {
                            driveSelect.value = drive;
                        }
                    }
                }
                
                renderBreadcrumb(data.rootPath);
                renderSummary(data);
                renderResults(data);
                updateCacheIndicator(true, false);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Failed to fetch data: ${error.message}</div>`;
                updateCacheIndicator(false, false);
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        // Ï∫êÏãú Í∞±Ïã† Ìï®Ïàò
        function refreshCache() {
            const pathInput = document.getElementById('pathInput');
            const targetPath = pathInput.value.trim();
            if (targetPath) {
                analyze(targetPath, true);
            }
        }

        function renderBreadcrumb(path) {
            const breadcrumbDiv = document.getElementById('breadcrumb');
            
            let parts;
            let separator;
            let rootPath;
            
            if (isWindows) {
                // Windows Í≤ΩÎ°ú Ï≤òÎ¶¨
                separator = '\\';
                parts = path.split('\\').filter(p => p);
                if (parts.length > 0 && parts[0].endsWith(':')) {
                    rootPath = parts[0] + '\\';
                    parts = parts.slice(1);
                } else {
                    rootPath = osInfo ? osInfo.defaultPath : 'C:\\';
                }
            } else {
                // Linux Í≤ΩÎ°ú Ï≤òÎ¶¨
                separator = '/';
                parts = path.split('/').filter(p => p);
                rootPath = '/';
            }

            // Í≤ΩÎ°ú Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ï≤òÎ¶¨
            const escapePath = (p) => p.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            
            let html = `<span onclick="analyze('${escapePath(rootPath)}')">Root</span>`;
            let currentPath = rootPath;

            parts.forEach((part, index) => {
                if (isWindows) {
                    currentPath += (currentPath.endsWith('\\') ? '' : '\\') + part;
                } else {
                    currentPath += '/' + part;
                }
                const p = escapePath(currentPath);
                html += ` ${separator} <span onclick="analyze('${p}')">${part}</span>`;
            });

            breadcrumbDiv.innerHTML = html;
            breadcrumbDiv.style.display = 'flex';
        }

        function renderSummary(data) {
            const summaryDiv = document.getElementById('summary');
            document.getElementById('totalSize').textContent = data.totalStr;
            document.getElementById('rootPath').textContent = data.rootPath;
            summaryDiv.style.display = 'block';
        }

        function renderResults(data) {
            const resultsDiv = document.getElementById('results');

            if (!data.items || data.items.length === 0) {
                resultsDiv.innerHTML = '<div class="empty">No items found in this directory</div>';
                return;
            }

            const maxSize = Math.max(...data.items.map(item => item.size));

            let html = '';
            data.items.forEach((item, index) => {
                const percentage = maxSize > 0 ? (item.size / maxSize) * 100 : 0;
                const icon = item.isDir ? 'üìÅ' : 'üìÑ';
                const hasChildren = item.children && item.children.length > 0;

                // Í≤ΩÎ°ú Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ï≤òÎ¶¨
                const escapedPath = item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                
                html += `
                    <div class="result-item" onclick="${item.isDir ? `analyze('${escapedPath}')` : ''}">
                        <div class="icon">${icon}</div>
                        <div class="info">
                            <div class="name">
                                ${item.name}
                                ${hasChildren ? `<button class="toggle-children" onclick="event.stopPropagation(); toggleChildren(${index})">Show children</button>` : ''}
                            </div>
                            <div class="path">${item.path}</div>
                        </div>
                        <div class="size-container">
                            <div class="size">${item.sizeStr}</div>
                            <div class="bar-container">
                                <div class="bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                    ${hasChildren ? `<div class="children" id="children-${index}" style="display: none;">${renderChildren(item.children, maxSize)}</div>` : ''}
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function renderChildren(children, maxSize) {
            return children.map(item => {
                const percentage = maxSize > 0 ? (item.size / maxSize) * 100 : 0;
                const icon = item.isDir ? 'üìÅ' : 'üìÑ';
                // Í≤ΩÎ°ú Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ï≤òÎ¶¨
                const escapedPath = item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

                return `
                    <div class="result-item" onclick="${item.isDir ? `analyze('${escapedPath}')` : ''}">
                        <div class="icon">${icon}</div>
                        <div class="info">
                            <div class="name">${item.name}</div>
                            <div class="path">${item.path}</div>
                        </div>
                        <div class="size-container">
                            <div class="size">${item.sizeStr}</div>
                            <div class="bar-container">
                                <div class="bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleChildren(index) {
            const childrenDiv = document.getElementById(`children-${index}`);
            const button = event.target;

            if (childrenDiv.style.display === 'none') {
                childrenDiv.style.display = 'block';
                button.textContent = 'Hide children';
            } else {
                childrenDiv.style.display = 'none';
                button.textContent = 'Show children';
            }
        }

        // Enter key handler
        document.getElementById('pathInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyze();
            }
        });

        // Initial load
        loadOSInfo().then(() => {
            analyze();
        });
    </script>
</body>
</html>
